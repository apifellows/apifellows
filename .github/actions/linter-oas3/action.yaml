name: 'OAS3 Linter'
description: 'Validates OpenAPI 3 specification files using ApiFellows Linter'
author: 'ApiFellows'

inputs:
  version:
    description: 'Linter API version to use (vlatest, v1, v2, ...)'
    required: false
    default: 'v1'
  file-path:
    description: 'Path to the OpenAPI 3 YAML file to validate'
    required: true
  continue-on-server-error:
    description: 'Continue execution if server returns 5xx error'
    required: false
    default: 'false'

outputs:
  result:
    description: 'Validation result (success, warning, error)'
    value: ${{ steps.validate.outputs.result }}
  status-code:
    description: 'HTTP status code from the API'
    value: ${{ steps.validate.outputs.status_code }}

runs:
  using: 'composite'
  steps:
    - name: Validate OpenAPI Specification
      id: validate
      shell: bash
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                 ApiFellows OAS3 Linter                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        FILE_PATH="${{ inputs.file-path }}"
        VERSION="${{ inputs.version }}"
        CONTINUE_ON_ERROR="${{ inputs.continue-on-server-error }}"
        API_URL="https://api.apifellows.com/linter-oas3/${VERSION}/oas3/checkfile"
        
        echo "ðŸ“‹ Configuration:"
        echo "   â€¢ File: $FILE_PATH"
        echo "   â€¢ API Version: $VERSION"
        echo "   â€¢ API URL: $API_URL"
        echo "   â€¢ Continue on Server Error: $CONTINUE_ON_ERROR"
        echo ""
        
        # Check if file exists
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ ERROR: File not found"
          echo "   Path: $FILE_PATH"
          echo ""
          echo "result=error" >> $GITHUB_OUTPUT
          echo "status_code=0" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ“ File found: $(basename "$FILE_PATH")"
        echo ""
        echo "ðŸ” Validating specification..."
        echo ""
        
        # Make API request
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -F "file=@$FILE_PATH" \
          "$API_URL")
        
        # Extract status code (last line)
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        
        # Extract body (everything except last line)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¡ API Response: HTTP $HTTP_CODE"
        echo ""
        
        # Handle different status codes
        case $HTTP_CODE in
          200)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… VALIDATION SUCCESSFUL"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Your OpenAPI specification is valid and meets all quality standards."
            echo ""
            echo "result=success" >> $GITHUB_OUTPUT
            exit 0
            ;;
            
          400)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ CLIENT ERROR - Invalid Request"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The file could not be processed. Please check:"
            echo "  â€¢ File format is valid YAML"
            echo "  â€¢ File extension is .yaml or .yml"
            echo "  â€¢ File is not empty"
            echo ""
            
            # Try to extract error message from response
            ERROR_MSG=$(echo "$BODY" | grep -o '"status_message":"[^"]*"' | cut -d'"' -f4 || echo "Unknown error")
            echo "Server message: $ERROR_MSG"
            echo ""
            
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
            
          422)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âš ï¸  VALIDATION FAILED - Issues Found"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Parse and display validation errors
            MESSAGES=$(echo "$BODY" | grep -o '"messages":\[[^]]*\]' || echo "")
            
            if [ ! -z "$MESSAGES" ]; then
              echo "The following issues were found in your specification:"
              echo ""
              
              # Extract individual messages (simplified parsing)
              echo "$BODY" | grep -o '"line":[0-9]*' | cut -d':' -f2 | while read LINE_NUM; do
                # This is a simplified version - you may need jq for proper JSON parsing
                echo "  âš  Line $LINE_NUM: Validation issue detected"
              done
              
              echo ""
              echo "ðŸ’¡ Tip: Review the specification at the indicated line numbers"
            else
              echo "Validation errors were detected but could not be parsed."
              echo ""
              echo "Full response:"
              echo "$BODY"
            fi
            
            echo ""
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
            
          5*)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ”§ SERVER ERROR"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The linter service encountered an error (HTTP $HTTP_CODE)."
            echo ""
            
            if [ "$CONTINUE_ON_ERROR" = "true" ]; then
              echo "âš ï¸  Continuing execution (continue-on-server-error: true)"
              echo ""
              echo "result=warning" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failing build (continue-on-server-error: false)"
              echo ""
              echo "ðŸ’¡ Tip: Set 'continue-on-server-error: true' to ignore server errors"
              echo ""
              echo "result=error" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
            
          *)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ UNEXPECTED RESPONSE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Received unexpected HTTP status code: $HTTP_CODE"
            echo ""
            echo "Response body:"
            echo "$BODY"
            echo ""
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac

branding:
  icon: 'check-circle'
  color: 'green'
