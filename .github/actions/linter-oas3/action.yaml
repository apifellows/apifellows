name: 'OAS3 Linter'
description: 'Validates OpenAPI 3 specification files using ApiFellows Linter'
author: 'ApiFellows'

inputs:
  version:
    description: 'Linter API version to use (vlatest, v1, v2, ...)'
    required: false
    default: 'v1'
  file-path:
    description: 'Path to the OpenAPI 3 YAML file to validate'
    required: true
  continue-on-server-error:
    description: 'Continue execution if server returns 5xx error'
    required: false
    default: 'false'
  continue-on-specification-error:
    description: 'Continue execution if specification validation fails (HTTP 422)'
    required: false
    default: 'false'

outputs:
  result:
    description: 'Validation result (success, warning, error)'
    value: ${{ steps.validate.outputs.result }}
  status-code:
    description: 'HTTP status code from the API'
    value: ${{ steps.validate.outputs.status_code }}

runs:
  using: 'composite'
  steps:
    - name: Validate OpenAPI Specification
      id: validate
      shell: bash
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                 ApiFellows OAS3 Linter                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        FILE_PATH="${{ inputs.file-path }}"
        VERSION="${{ inputs.version }}"
        CONTINUE_ON_ERROR="${{ inputs.continue-on-server-error }}"
        CONTINUE_ON_SPEC_ERROR="${{ inputs.continue-on-specification-error }}"
        API_URL="https://api.apifellows.com/linter-oas3/${VERSION}/oas3/checkfile"
        
        echo "ðŸ“‹ Configuration:"
        echo "   â€¢ File: $FILE_PATH"
        echo "   â€¢ API Version: $VERSION"
        echo "   â€¢ API URL: $API_URL"
        echo "   â€¢ Continue on Server Error: $CONTINUE_ON_ERROR"
        echo "   â€¢ Continue on Specification Error: $CONTINUE_ON_SPEC_ERROR"
        echo ""
        
        # Check if file exists
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ ERROR: File not found"
          echo "   Path: $FILE_PATH"
          echo ""
          echo "result=error" >> $GITHUB_OUTPUT
          echo "status_code=0" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ“ File found: $(basename "$FILE_PATH")"
        echo ""
        echo "ðŸ” Validating specification..."
        echo ""
        
        # Make API request with proper content type header
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Accept: application/json" \
          -F "file=@${FILE_PATH};type=application/x-yaml" \
          "$API_URL")
        
        # Extract status code (last line)
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        
        # Extract body (everything except last line)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¡ API Response: HTTP $HTTP_CODE"
        echo ""
        
        # Handle different status codes
        case $HTTP_CODE in
          200)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… VALIDATION SUCCESSFUL"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Extract metrics using sed/awk for better compatibility
            # Extract score.total
            TOTAL_SCORE=$(echo "$BODY" | sed -n 's/.*"score"[[:space:]]*:[[:space:]]*{[^}]*"total"[[:space:]]*:[[:space:]]*\([0-9]*\).*/\1/p' | head -1)
            [ -z "$TOTAL_SCORE" ] && TOTAL_SCORE="N/A"
            
            # Extract metrics.total.total.passed
            TOTAL_PASSED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | tail -1 | grep -o '"passed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$TOTAL_PASSED" ] && TOTAL_PASSED="0"
            
            # Extract metrics.total.must.failed
            MUST_FAILED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | grep -o '"must"[^}]*' | grep -o '"failed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$MUST_FAILED" ] && MUST_FAILED="0"
            
            # Extract metrics.total.should.failed  
            SHOULD_FAILED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | grep -o '"should"[^}]*' | grep -o '"failed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$SHOULD_FAILED" ] && SHOULD_FAILED="0"
            
            # Extract metrics.total.optional.failed
            OPTIONAL_FAILED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | grep -o '"optional"[^}]*' | grep -o '"failed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$OPTIONAL_FAILED" ] && OPTIONAL_FAILED="0"
            
            echo "ðŸ“Š Quality Metrics:"
            echo "   â€¢ Total Score:        ${TOTAL_SCORE}%"
            echo "   â€¢ Total Passed:       ${TOTAL_PASSED}"
            echo "   â€¢ Total MUST Errors:  ${MUST_FAILED}"
            echo "   â€¢ Total SHOULD Errors: ${SHOULD_FAILED}"
            echo "   â€¢ Total COULD Errors:  ${OPTIONAL_FAILED}"
            echo ""
            echo "ðŸ”— View detailed report: https://www.apifellows.com/"
            echo ""
            
            echo "result=success" >> $GITHUB_OUTPUT
            exit 0
            ;;
            
          400)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ CLIENT ERROR - Invalid Request"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The file could not be processed. Please check:"
            echo "  â€¢ File format is valid YAML"
            echo "  â€¢ File extension is .yaml or .yml"
            echo "  â€¢ File is not empty"
            echo ""
            
            # Try to extract error message from response
            ERROR_MSG=$(echo "$BODY" | grep -o '"status_message":"[^"]*"' | cut -d'"' -f4 || echo "Unknown error")
            echo "Server message: $ERROR_MSG"
            echo ""
            
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
            
          422)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âš ï¸  VALIDATION FAILED - Issues Found"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Extract metrics using sed/awk for better compatibility
            # Extract score.total
            TOTAL_SCORE=$(echo "$BODY" | sed -n 's/.*"score"[[:space:]]*:[[:space:]]*{[^}]*"total"[[:space:]]*:[[:space:]]*\([0-9]*\).*/\1/p' | head -1)
            [ -z "$TOTAL_SCORE" ] && TOTAL_SCORE="N/A"
            
            # Extract metrics.total.total.passed
            TOTAL_PASSED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | tail -1 | grep -o '"passed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$TOTAL_PASSED" ] && TOTAL_PASSED="0"
            
            # Extract metrics.total.must.failed
            MUST_FAILED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | grep -o '"must"[^}]*' | grep -o '"failed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$MUST_FAILED" ] && MUST_FAILED="0"
            
            # Extract metrics.total.should.failed  
            SHOULD_FAILED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | grep -o '"should"[^}]*' | grep -o '"failed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$SHOULD_FAILED" ] && SHOULD_FAILED="0"
            
            # Extract metrics.total.optional.failed
            OPTIONAL_FAILED=$(echo "$BODY" | grep -o '"metrics"[^}]*' | grep -o '"total"[^}]*' | grep -o '"optional"[^}]*' | grep -o '"failed":[0-9]*' | grep -o '[0-9]*' | head -1)
            [ -z "$OPTIONAL_FAILED" ] && OPTIONAL_FAILED="0"
            
            echo "ðŸ“Š Quality Metrics:"
            echo "   â€¢ Total Score:        ${TOTAL_SCORE}%"
            echo "   â€¢ Total Passed:       ${TOTAL_PASSED}"
            echo "   â€¢ Total MUST Errors:  ${MUST_FAILED}"
            echo "   â€¢ Total SHOULD Errors: ${SHOULD_FAILED}"
            echo "   â€¢ Total COULD Errors:  ${OPTIONAL_FAILED}"
            echo ""
            echo "ðŸ”— View detailed report: https://www.apifellows.com/"
            echo ""
            
            # Extract and display MUST errors
            echo "âŒ MUST Errors (must be fixed):"
            echo ""
            
            # Extract messages with proper JSON parsing (simplified - works for most cases)
            echo "$BODY" | grep -o '"severity":"MUST"[^}]*"status":"FAIL"[^}]*' | while IFS= read -r MSG; do
              LINE=$(echo "$MSG" | grep -o '"line":[0-9]*' | cut -d':' -f2)
              TITLE=$(echo "$MSG" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
              
              if [ ! -z "$LINE" ] && [ ! -z "$TITLE" ]; then
                echo "  â€¢ Line $LINE: $TITLE"
              fi
            done
            
            # Alternative approach if the first one doesn't capture all errors
            if ! echo "$BODY" | grep -q '"severity":"MUST"[^}]*"status":"FAIL"'; then
              # Fallback: just extract line numbers for FAIL status
              echo "$BODY" | grep -o '"status":"FAIL"[^}]*"line":[0-9]*' | while IFS= read -r MSG; do
                LINE=$(echo "$MSG" | grep -o '"line":[0-9]*' | cut -d':' -f2)
                if [ ! -z "$LINE" ]; then
                  echo "  â€¢ Line $LINE: Validation error"
                fi
              done
            fi
            
            echo ""
            
            if [ "$CONTINUE_ON_SPEC_ERROR" = "true" ]; then
              echo "âš ï¸  Continuing execution (continue-on-specification-error: true)"
              echo ""
              echo "result=warning" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failing build (continue-on-specification-error: false)"
              echo ""
              echo "ðŸ’¡ Tip: Set 'continue-on-specification-error: true' to ignore validation errors"
              echo ""
              echo "result=error" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
            
          5*)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ”§ SERVER ERROR"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The linter service encountered an error (HTTP $HTTP_CODE)."
            echo ""
            
            if [ "$CONTINUE_ON_ERROR" = "true" ]; then
              echo "âš ï¸  Continuing execution (continue-on-server-error: true)"
              echo ""
              echo "result=warning" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failing build (continue-on-server-error: false)"
              echo ""
              echo "ðŸ’¡ Tip: Set 'continue-on-server-error: true' to ignore server errors"
              echo ""
              echo "result=error" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
            
          *)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ UNEXPECTED RESPONSE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Received unexpected HTTP status code: $HTTP_CODE"
            echo ""
            echo "Response body:"
            echo "$BODY"
            echo ""
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac

branding:
  icon: 'check-circle'
  color: 'green'
