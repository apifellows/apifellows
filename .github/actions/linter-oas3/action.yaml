name: 'OAS3 Linter'
description: 'Validates OpenAPI 3 specification files using ApiFellows Linter'
author: 'ApiFellows'

inputs:
  version:
    description: 'Linter API version to use (vlatest, v1, v2, ...)'
    required: false
    default: 'v1'
  file-path:
    description: 'Path to the OpenAPI 3 YAML file to validate'
    required: true
  continue-on-server-error:
    description: 'Continue execution if server returns 5xx error'
    required: false
    default: 'false'
  continue-on-specification-error:
    description: 'Continue execution if specification validation fails (HTTP 422)'
    required: false
    default: 'false'

outputs:
  result:
    description: 'Validation result (success, warning, error)'
    value: ${{ steps.validate.outputs.result }}
  status-code:
    description: 'HTTP status code from the API'
    value: ${{ steps.validate.outputs.status_code }}

runs:
  using: 'composite'
  steps:
    - name: Validate OpenAPI Specification
      id: validate
      shell: bash
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                 ApiFellows OAS3 Linter                           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        FILE_PATH="${{ inputs.file-path }}"
        VERSION="${{ inputs.version }}"
        CONTINUE_ON_ERROR="${{ inputs.continue-on-server-error }}"
        CONTINUE_ON_SPEC_ERROR="${{ inputs.continue-on-specification-error }}"
        API_URL="https://api.apifellows.com/linter-oas3/${VERSION}/oas3/checkfile"
        
        echo "ðŸ“‹ Configuration:"
        echo "   â€¢ File: $FILE_PATH"
        echo "   â€¢ API Version: $VERSION"
        echo "   â€¢ API URL: $API_URL"
        echo "   â€¢ Continue on Server Error: $CONTINUE_ON_ERROR"
        echo "   â€¢ Continue on Specification Error: $CONTINUE_ON_SPEC_ERROR"
        echo ""
        
        # Check if file exists
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ ERROR: File not found"
          echo "   Path: $FILE_PATH"
          echo ""
          echo "result=error" >> $GITHUB_OUTPUT
          echo "status_code=0" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ“ File found: $(basename "$FILE_PATH")"
        echo ""
        echo "ðŸ” Validating specification..."
        echo ""
        
        # Make API request with proper content type header
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Accept: application/json" \
          -F "file=@${FILE_PATH};type=application/x-yaml" \
          "$API_URL")
        
        # Extract status code (last line)
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        
        # Extract body (everything except last line)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo "status_code=$HTTP_CODE" >> $GITHUB_OUTPUT
        
        echo "ðŸ“¡ API Response: HTTP $HTTP_CODE"
        echo ""
        
        # Debug: Show response body if not 200
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Response body:"
          echo "$BODY"
          echo ""
        fi
        echo ""
        
        # Handle different status codes
        case $HTTP_CODE in
          200)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… VALIDATION SUCCESSFUL"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Your OpenAPI specification is valid and meets all quality standards."
            echo ""
            echo "result=success" >> $GITHUB_OUTPUT
            exit 0
            ;;
            
          400)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ CLIENT ERROR - Invalid Request"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The file could not be processed. Please check:"
            echo "  â€¢ File format is valid YAML"
            echo "  â€¢ File extension is .yaml or .yml"
            echo "  â€¢ File is not empty"
            echo ""
            
            # Try to extract error message from response
            ERROR_MSG=$(echo "$BODY" | grep -o '"status_message":"[^"]*"' | cut -d'"' -f4 || echo "Unknown error")
            echo "Server message: $ERROR_MSG"
            echo ""
            
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
            
          422)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âš ï¸  VALIDATION FAILED - Issues Found"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Extract overall score
            TOTAL_SCORE=$(echo "$BODY" | grep -o '"total":[0-9]*' | head -1 | cut -d':' -f2 || echo "N/A")
            echo "ðŸ“Š Overall Quality Score: ${TOTAL_SCORE}%"
            echo ""
            
            # Display metrics table
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ Section      â”‚ Failed MUST â”‚ Failed SHOULDâ”‚ Failed COULD â”‚ Failed Total â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            
            # Extract metrics for each section
            for SECTION in yaml oas info servers security paths components tags externaldocs total; do
              # Extract failed counts for each severity
              MUST_FAILED=$(echo "$BODY" | grep -o "\"$SECTION\":{[^}]*\"must\":{[^}]*\"failed\":[0-9]*" | grep -o "\"failed\":[0-9]*" | cut -d':' -f2 || echo "0")
              SHOULD_FAILED=$(echo "$BODY" | grep -o "\"$SECTION\":{[^}]*\"should\":{[^}]*\"failed\":[0-9]*" | grep -o "\"failed\":[0-9]*" | cut -d':' -f2 || echo "0")
              OPTIONAL_FAILED=$(echo "$BODY" | grep -o "\"$SECTION\":{[^}]*\"optional\":{[^}]*\"failed\":[0-9]*" | grep -o "\"failed\":[0-9]*" | cut -d':' -f2 || echo "0")
              TOTAL_FAILED=$(echo "$BODY" | grep -o "\"$SECTION\":{[^}]*\"total\":{[^}]*\"failed\":[0-9]*" | grep -o "\"failed\":[0-9]*" | cut -d':' -f2 || echo "0")
              
              # Default to 0 if empty
              MUST_FAILED=${MUST_FAILED:-0}
              SHOULD_FAILED=${SHOULD_FAILED:-0}
              OPTIONAL_FAILED=${OPTIONAL_FAILED:-0}
              TOTAL_FAILED=${TOTAL_FAILED:-0}
              
              # Format section name with proper capitalization
              SECTION_NAME=$(echo "$SECTION" | awk '{print toupper(substr($0,1,1)) tolower(substr($0,2))}')
              
              # Add separator before total row
              if [ "$SECTION" = "total" ]; then
                echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
                SECTION_NAME="TOTAL"
              fi
              
              # Print row with proper padding
              printf "â”‚ %-12s â”‚ %11s â”‚ %12s â”‚ %12s â”‚ %12s â”‚\n" \
                "$SECTION_NAME" "$MUST_FAILED" "$SHOULD_FAILED" "$OPTIONAL_FAILED" "$TOTAL_FAILED"
            done
            
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            
            # Extract and display MUST errors
            echo "âŒ MUST Errors (must be fixed):"
            echo ""
            
            # Use a temporary file to store MUST errors
            TEMP_FILE=$(mktemp)
            
            # Extract messages with proper JSON parsing (simplified - works for most cases)
            echo "$BODY" | grep -o '"severity":"MUST"[^}]*"status":"FAIL"[^}]*' | while IFS= read -r MSG; do
              LINE=$(echo "$MSG" | grep -o '"line":[0-9]*' | cut -d':' -f2)
              TITLE=$(echo "$MSG" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
              
              if [ ! -z "$LINE" ] && [ ! -z "$TITLE" ]; then
                echo "  â€¢ Line $LINE: $TITLE"
              fi
            done
            
            # Alternative approach if the first one doesn't capture all errors
            if ! echo "$BODY" | grep -q '"severity":"MUST"[^}]*"status":"FAIL"'; then
              # Fallback: just extract line numbers for FAIL status
              echo "$BODY" | grep -o '"status":"FAIL"[^}]*"line":[0-9]*' | while IFS= read -r MSG; do
                LINE=$(echo "$MSG" | grep -o '"line":[0-9]*' | cut -d':' -f2)
                if [ ! -z "$LINE" ]; then
                  echo "  â€¢ Line $LINE: Validation error"
                fi
              done
            fi
            
            echo ""
            echo "â„¹ï¸  For detailed information about PASSED rules, SHOULD recommendations,"
            echo "   and COULD suggestions, please visit:"
            echo ""
            echo "   ðŸ”— https://www.apifellows.com/"
            echo ""
            
            rm -f "$TEMP_FILE"
            echo ""
            
            if [ "$CONTINUE_ON_SPEC_ERROR" = "true" ]; then
              echo "âš ï¸  Continuing execution (continue-on-specification-error: true)"
              echo ""
              echo "result=warning" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failing build (continue-on-specification-error: false)"
              echo ""
              echo "ðŸ’¡ Tip: Set 'continue-on-specification-error: true' to ignore validation errors"
              echo ""
              echo "result=error" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
            
          5*)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ”§ SERVER ERROR"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The linter service encountered an error (HTTP $HTTP_CODE)."
            echo ""
            
            if [ "$CONTINUE_ON_ERROR" = "true" ]; then
              echo "âš ï¸  Continuing execution (continue-on-server-error: true)"
              echo ""
              echo "result=warning" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failing build (continue-on-server-error: false)"
              echo ""
              echo "ðŸ’¡ Tip: Set 'continue-on-server-error: true' to ignore server errors"
              echo ""
              echo "result=error" >> $GITHUB_OUTPUT
              exit 1
            fi
            ;;
            
          *)
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ UNEXPECTED RESPONSE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Received unexpected HTTP status code: $HTTP_CODE"
            echo ""
            echo "Response body:"
            echo "$BODY"
            echo ""
            echo "result=error" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac

branding:
  icon: 'check-circle'
  color: 'green'
